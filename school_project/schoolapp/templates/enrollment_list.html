<!DOCTYPE html>
<html>
<head>
    <title>Enrollment Management</title>
    <style>
        table { border-collapse: collapse; width: 80%; }
        th, td { border: 1px solid #333; padding: 5px; text-align: center; }
        form.inline { display: inline; margin: 0; }
        label { margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Enrollments</h1>

    <!-- CREATE / EDIT Form -->
    <h2 id="formTitle">Add New Enrollment</h2>
    <form id="enrollmentForm">
        <input type="hidden" id="enrollmentId">

        <label>Student:
            <select id="studentSelect" required>
                <!-- JS orqali studentlar yuklanadi -->
            </select>
        </label>

        <label>Course:
            <select id="courseSelect" required>
                <!-- JS orqali kurslar yuklanadi -->
            </select>
        </label>

        <button type="submit">Save</button>
        <button type="button" id="cancelEdit" style="display:none;">Cancel</button>
    </form>

    <hr>

    <!-- Enrollment Table -->
    <table id="enrollmentTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Student</th>
                <th>Course</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const apiUrl = '/school/enrollment/';  // DRF router endpoint
        const csrfToken = '{{ csrf_token }}';
        let students = [];
        let courses = [];

        // Load students and courses for dropdown
        function loadStudentsAndCourses() {
            fetch('/school/student/')
                .then(res => res.json())
                .then(data => {
                    students = data;
                    const studentSelect = document.getElementById('studentSelect');
                    studentSelect.innerHTML = '';
                    students.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.text = s.name; // yoki s.first_name + " " + s.last_name
                        studentSelect.appendChild(option);
                    });
                });

            fetch('/school/course/')
                .then(res => res.json())
                .then(data => {
                    courses = data;
                    const courseSelect = document.getElementById('courseSelect');
                    courseSelect.innerHTML = '';
                    courses.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.text = c.title;
                        courseSelect.appendChild(option);
                    });
                });
        }

                function fetchEnrollments() {
            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#enrollmentTable tbody');
                    tbody.innerHTML = '';
                    data.forEach(enr => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${enr.id}</td>
                            <td>${enr.student_name}</td>
                            <td>${enr.course_title}</td>
                            <td>
                                <button onclick="editEnrollment(${enr.id}, ${enr.student}, ${enr.course})">Edit</button>
                                <button onclick="deleteEnrollment(${enr.id})">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }


        // CREATE / UPDATE
        document.getElementById('enrollmentForm').addEventListener('submit', function(e){
            e.preventDefault();
            const id = document.getElementById('enrollmentId').value;
            const payload = {
                student: parseInt(document.getElementById('studentSelect').value),
                course: parseInt(document.getElementById('courseSelect').value)
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiUrl}${id}/` : apiUrl;

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error('Network response was not ok');
                return res.json();
            })
            .then(() => {
                fetchEnrollments();
                resetForm();
            });
        });

        // Edit
        function editEnrollment(id, studentId, courseId) {
            document.getElementById('formTitle').innerText = 'Edit Enrollment';
            document.getElementById('enrollmentId').value = id;
            document.getElementById('studentSelect').value = studentId;
            document.getElementById('courseSelect').value = courseId;
            document.getElementById('cancelEdit').style.display = 'inline';
        }

        // Cancel Edit
        document.getElementById('cancelEdit').addEventListener('click', resetForm);

        function resetForm() {
            document.getElementById('formTitle').innerText = 'Add New Enrollment';
            document.getElementById('enrollmentId').value = '';
            document.getElementById('studentSelect').value = '';
            document.getElementById('courseSelect').value = '';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        // Delete
        function deleteEnrollment(id) {
            if(confirm('Are you sure you want to delete this enrollment?')) {
                fetch(`${apiUrl}${id}/`, {
                    method: 'DELETE',
                    headers: {'X-CSRFToken': csrfToken}
                }).then(() => fetchEnrollments());
            }
        }

        // Initial load
        loadStudentsAndCourses();
        setTimeout(fetchEnrollments, 300); // dropdownlar yuklanganidan keyin jadval yuklansin
    </script>
</body>
</html>
