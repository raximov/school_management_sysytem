<!DOCTYPE html>
<html>
<head>
    <title>Javoblar CRUD</title>
</head>
<body>
    <h1>Javoblar</h1>

    <button onclick="goBack()">‚¨Ö Savollarga qaytish</button>

    <form id="answerForm">
        <input type="hidden" id="answerId" />
        <input type="text" id="answerText" placeholder="Javob matni" required />
        <label>
            <input type="checkbox" id="isCorrect" /> To‚Äòg‚Äòri javob
        </label>
        <button type="submit">Saqlash</button>
        <button type="button" id="resetAnswerForm">Tozalash</button>
    </form>

    <ul id="answerList"></ul>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const questionId = urlParams.get('question');
        if(!questionId) alert('Savol ID topilmadi!');

        const API = `/api/teacher/answers/?question=${questionId}`;

        async function fetchAnswers() {
            const res = await fetch(API);
            const answers = await res.json();
            const ul = document.getElementById('answerList');
            ul.innerHTML = '';
            answers.forEach(a => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${a.text} ${a.is_correct ? '(‚úî)' : ''}
                    <button onclick="editAnswer(${a.id}, '${a.text}', ${a.is_correct})">‚úèÔ∏è</button>
                    <button onclick="deleteAnswer(${a.id})">üóëÔ∏è</button>
                `;
                ul.appendChild(li);
            });
        }

        document.getElementById('answerForm').onsubmit = async e => {
            e.preventDefault();
            const id = document.getElementById('answerId').value;
            const text = document.getElementById('answerText').value;
            const is_correct = document.getElementById('isCorrect').checked;

            const payload = {text, is_correct, question: questionId};

            if(id) {
                await fetch(`/api/teacher/answers/${id}/`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
            } else {
                await fetch('/api/teacher/answers/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
            }

            resetForm();
            fetchAnswers();
        };

        function editAnswer(id, text, is_correct) {
            document.getElementById('answerId').value = id;
            document.getElementById('answerText').value = text;
            document.getElementById('isCorrect').checked = is_correct;
        }
        function resetForm() {
            document.getElementById('answerId').value = '';
            document.getElementById('answerText').value = '';
            document.getElementById('isCorrect').checked = false;
        }
        document.getElementById('resetAnswerForm').onclick = resetForm;

        async function deleteAnswer(id) {
            if(confirm('Javob o\'chirilsinmi?')) {
                await fetch(`/api/teacher/answers/${id}/`, {method: 'DELETE'});
                fetchAnswers();
            }
        }

        function goBack() {
            window.location.href = `teacher_questions.html?test=${questionId}`;
        }

        fetchAnswers();
    </script>
</body>
</html>
