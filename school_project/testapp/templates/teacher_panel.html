{% extends 'base.html' %}

{% block content %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Teacher Panel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

<!-- 📚 TESTLAR -->
<h2>📚 Testlar</h2>
<form id="testForm" class="mb-3">
    <input type="hidden" id="testId">
    <input type="text" id="testName" placeholder="Test nomi" class="form-control mb-2" required>
    <button type="submit" class="btn btn-primary">Saqlash</button>
</form>

<table class="table table-bordered" id="testTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Test nomi</th>
            <th>Harakatlar</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<hr>

<!-- ❓ SAVOLLAR -->
<h2>❓ Savollar</h2>
<form id="questionForm" class="mb-3">
    <input type="hidden" id="questionId">
    <select id="questionTest" class="form-control mb-2" required></select>
    <input type="text" id="questionText" placeholder="Savol matni" class="form-control mb-2" required>
    <select id="questionType" class="form-control mb-2" required>
        <option value="OC">One choice</option>
        <option value="MC">Multiple choice</option>
        <option value="WR">Written</option>
        <!-- boshqa turlar -->
    </select>
    <input type="number" step="0.1" id="questionMark" placeholder="Ball" class="form-control mb-2">

    <button type="submit" class="btn btn-primary">Saqlash</button>
</form>

<table class="table table-bordered" id="questionTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Test</th>
            <th>Savol</th>
            <th>Ball</th>
            <th>Tur</th>
            <th>Harakatlar</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<hr>

<!-- 💡 JAVOBLAR -->
<h2>💡 Javoblar</h2>
<form id="answerForm" class="mb-3">
    <input type="hidden" id="answerId">
    <select id="answerQuestion" class="form-control mb-2" required></select>
    <input type="text" id="answerText" placeholder="Javob matni" class="form-control mb-2" required>
    <div class="form-check mb-2">
        <input type="checkbox" id="isCorrect" class="form-check-input">
        <label for="isCorrect" class="form-check-label">To‘g‘ri javob</label>
    </div>
    <button type="submit" class="btn btn-primary">Saqlash</button>
</form>

<table class="table table-bordered" id="answerTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Savol</th>
            <th>Javob</th>
            <th>To‘g‘ri</th>
            <th>Harakatlar</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
// CSRF tokenni cookie'dan olish uchun funksiya
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

const API_TESTS = '/testapp/teacher/tests/';
const API_QUESTIONS = '/testapp/teacher/questions/';
const API_ANSWERS = '/testapp/teacher/answers/';

document.addEventListener('DOMContentLoaded', () => {
    loadTests();
    loadQuestions();
    loadAnswers();
});

// ================= TEST CRUD =================
function loadTests() {
    fetch(API_TESTS).then(r => r.json()).then(data => {
        const tbody = document.querySelector('#testTable tbody');
        const select = document.getElementById('questionTest');
        tbody.innerHTML = '';
        select.innerHTML = '';
        data.forEach(t => {
            tbody.innerHTML += `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.title}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editTest(${t.id}, '${t.title}')">✏</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTest(${t.id})">🗑</button>
                    </td>
                </tr>
            `;
            select.innerHTML += `<option value="${t.id}">${t.title}</option>`;
        });
    });
}

function editTest(id, title) {
    document.getElementById('testId').value = id;
    document.getElementById('testName').value = title;
}

function deleteTest(id) {
    fetch(API_TESTS + id + '/', { 
        method: 'DELETE',
        headers: { 'X-CSRFToken': csrftoken },
    }).then(() => loadTests());
}

document.getElementById('testForm').addEventListener('submit', e => {
    e.preventDefault();
    const id = document.getElementById('testId').value;
    const title = document.getElementById('testName').value;
    const method = id ? 'PUT' : 'POST';
    const url = id ? API_TESTS + id + '/' : API_TESTS;
    fetch(url, {
        method,
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ title })
    }).then(() => {
        e.target.reset();
        loadTests();
    });
});

// ================= QUESTION CRUD =================
function loadQuestions() {
    fetch(API_QUESTIONS).then(r => r.json()).then(data => {
        const tbody = document.querySelector('#questionTable tbody');
        const select = document.getElementById('answerQuestion');
        tbody.innerHTML = '';
        select.innerHTML = '';
        data.forEach(q => {
            tbody.innerHTML += `
                <tr>
                    <td>${q.id}</td>
                    <td>${q.test}</td>
                    <td>${q.text}</td>
                    <td>${q.question_type}</td>
                    <td>${q.mark}</td>

                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editQuestion(${q.id}, '${q.text.replace(/'/g, "\\'")}', ${q.test}, '${q.question_type}', ${q.mark})">✏</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteQuestion(${q.id})">🗑</button>
                    </td>
                </tr>
            `;
            select.innerHTML += `<option value="${q.id}">${q.text}</option>`;
        });
    });
}

function editQuestion(id, text, testId, mark) {
    document.getElementById('questionId').value = id;
    document.getElementById('questionText').value = text;
    document.getElementById('questionTest').value = testId;
    document.getElementById('questionType').value = question_type;  // Default type, change as needed
    document.getElementById('questionMark').value = mark;

}

function deleteQuestion(id) {
    fetch(API_QUESTIONS + id + '/', { 
        method: 'DELETE',
        headers: { 'X-CSRFToken': csrftoken }
    }).then(() => loadQuestions());
}

document.getElementById('questionForm').addEventListener('submit', e => {
    e.preventDefault();
    const id = document.getElementById('questionId').value;
    const test = document.getElementById('questionTest').value;
    const text = document.getElementById('questionText').value;
    const question_type = document.getElementById('questionType').value;
    const mark = document.getElementById('questionMark').value;

    const method = id ? 'PUT' : 'POST';
    const url = id ? API_QUESTIONS + id + '/' : API_QUESTIONS;
    fetch(url, {
        method,
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken  // agar CSRF token kerak bo‘lsa
        },
        body: JSON.stringify({ test, text, mark, question_type })  // question_type qo'shildi
    }).then(() => {
        e.target.reset();
        loadQuestions();
    });
});


// ================= ANSWER CRUD =================
function loadAnswers() {
    fetch(API_ANSWERS).then(r => r.json()).then(data => {
        const tbody = document.querySelector('#answerTable tbody');
        tbody.innerHTML = '';
        data.forEach(a => {
            tbody.innerHTML += `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.question}</td>
                    <td>${a.text}</td>
                    <td>${a.is_correct ? '✅' : '❌'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editAnswer(${a.id}, '${a.text}', ${a.question}, ${a.is_correct})">✏</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAnswer(${a.id})">🗑</button>
                    </td>
                </tr>
            `;
        });
    });
}

function editAnswer(id, text, questionId, isCorrect) {
    document.getElementById('answerId').value = id;
    document.getElementById('answerText').value = text;
    document.getElementById('answerQuestion').value = questionId;
    document.getElementById('isCorrect').checked = isCorrect;
}

function deleteAnswer(id) {
    fetch(API_ANSWERS + id + '/', { 
        method: 'DELETE',
        headers: { 'X-CSRFToken': csrftoken }
    }).then(() => loadAnswers());
}

document.getElementById('answerForm').addEventListener('submit', e => {
    e.preventDefault();
    const id = document.getElementById('answerId').value;
    const question = document.getElementById('answerQuestion').value;
    const text = document.getElementById('answerText').value;
    const is_correct = document.getElementById('isCorrect').checked;
    const method = id ? 'PUT' : 'POST';
    const url = id ? API_ANSWERS + id + '/' : API_ANSWERS;
    fetch(url, {
        method,
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ question, text, is_correct })
    }).then(() => {
        e.target.reset();
        loadAnswers();
    });
});
</script>
</body>
</html>
{% endblock %}