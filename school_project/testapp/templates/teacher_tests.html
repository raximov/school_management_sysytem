{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Teacher Panel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

<!-- ğŸ“š TESTLAR -->
<h2>ğŸ“š Testlar</h2>
<form id="testForm" class="mb-3">
    <input type="hidden" id="testId">
    <input type="text" id="testName" placeholder="Test nomi" class="form-control mb-2" required>
    <button type="submit" class="btn btn-primary">Saqlash</button>
    <button type="button" id="resetBtn" class="btn btn-secondary ms-2">Tozalash</button>
</form>

<table class="table table-bordered" id="testTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Test nomi</th>
            <th>Harakatlar</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Agar select kerak boâ€˜lsa, mana shu yerga qoâ€˜shing, hozir JSda bor lekin HTMLda yoâ€˜q -->
<!--
<select id="questionTest" class="form-select mb-3"></select>
-->

<script>
    const API_TESTS = 'http://localhost:8000/test/teacher/tests/';  // Backend API manzilingiz

    // Belgilarni qochirish
    function escapeQuotes(str) {
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    async function loadTests() {
    try {
        const response = await fetch(API_TESTS);
        const text = await response.text();
        console.log('Javob:', text); // Javobni konsolga chiqaramiz

        // JSON parse qilishdan oldin javob HTML emasligini tekshirish uchun
        let data;
        try {
            data = JSON.parse(text);
        } catch {
            throw new Error('Serverdan JSON emas, balki HTML yoki notoâ€˜gâ€˜ri maâ€™lumot keldi');
        }

        // Shu yerda data bilan ishlash
        // ...
    } catch (err) {
        alert('Xatolik: ' + err.message);
    }
}

    async function loadTests() {
        try {
            const response = await fetch(API_TESTS);
            if (!response.ok) throw new Error('Server javob bermadi: ' + response.status);
            const data = await response.json();

            const tbody = document.querySelector('#testTable tbody');
            tbody.innerHTML = '';

            // Agar sizda select kerak bo'lsa, quyidagi kodni yoqing va HTMLga select qo'shing
            // const select = document.getElementById('questionTest');
            // select.innerHTML = '';

            data.forEach(t => {
                tbody.innerHTML += `
                    <tr>
                        <td>${t.id}</td>
                        <td>${t.title}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editTest(${t.id}, '${escapeQuotes(t.title)}')">âœ</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTest(${t.id})">ğŸ—‘</button>
                        </td>
                    </tr>
                `;

                // Agar select kerak boâ€˜lsa:
                // select.innerHTML += `<option value="${t.id}">${t.title}</option>`;
            });
        } catch (error) {
            alert('Testlarni yuklashda xatolik: ' + error.message);
        }
    }

    function editTest(id, title) {
        document.getElementById('testId').value = id;
        document.getElementById('testName').value = title;
    }

    async function deleteTest(id) {
        if (!confirm('Testni oâ€˜chirilsinmi?')) return;

        try {
            const response = await fetch(API_TESTS + id + '/', { method: 'DELETE' });
            if (!response.ok) throw new Error('Oâ€˜chirishda xatolik: ' + response.status);
            await loadTests();
        } catch (error) {
            alert(error.message);
        }
    }

    document.getElementById('testForm').addEventListener('submit', async e => {
        e.preventDefault();

        const id = document.getElementById('testId').value;
        const title = document.getElementById('testName').value.trim();

        if (!title) {
            alert('Test nomi boâ€˜sh boâ€˜lishi mumkin emas!');
            return;
        }

        const method = id ? 'PUT' : 'POST';
        const url = id ? API_TESTS + id + '/' : API_TESTS;

        try {
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title })
            });
            if (!response.ok) throw new Error('Saqlashda xatolik: ' + response.status);
            e.target.reset();
            document.getElementById('testId').value = '';
            await loadTests();
        } catch (error) {
            alert(error.message);
        }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('testForm').reset();
        document.getElementById('testId').value = '';
    });

    // Sahifa yuklanganda testlarni yuklash
    loadTests();
</script>

</body>
</html>
